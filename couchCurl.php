<?php

define('COUCH_HOST','http://localhost:5984');
define('COUCH_DB','test');

class couchCurl{
        // if no title provided statement changes to a PUT and the title is generated by couchdb
        function _cc_put($json,$title=NULL,$database=NULL){return self::__cc( ($title == NULL?'POST':'PUT'  ) , ($title==NULL?"'":"/$title'"). " -d \ '$json'",$database);}
        
        function _cc_get($title,$range_stop=FALSE,$database=NULL){return self::__cc('GET',"/$title'",$database);}

        function _cc_delete($title,$rev,$database=NULL){return self::__cc('DELETE',"/$title?rev=$rev'".' -H "Content-Length:1"',$database);}

        function _cc_set_revs_limit($limit=1000,$database=NULL){
                return(exec('curl -X PUT -d "'.$limit.'" '. "'http://localhost:5984/".($database==NULL?COUCH_DB:$database)."/_revs_limit' -s"));
        }

        function _cc_changes($database=NULL,$options=NULL){
                if($options!=NULL && is_array($options))
                        $options = http_build_query($options);
                return self::__cc('GET',"/_changes".(is_string($options)?$options:NULL) ."'",$database);
        }

        function _cc_get_revs_limit($database=NULL){
                if($database == NULL) $database = COUCH_DB ;
                return(self::__cc_host("/$database/_revs_limit'"));
        }

        function _cc_get_all_dbs(){
                return(self::__cc_host("/_all_dbs'"));
        }

/* coming soon...        
// generated commands work - but php wont display them for some reason..
        function _cc_all_docs($by_seq=false){return self::__cc('GET',"/_all_docs'" . ($by_seq?'_by_seq':NULL));}
// functions not tested yet...
        function _cc_get_att($title,$name){return self::__cc('GET',"/$title/$name'");}
        function _cc_copy($doc,$dest,$rev_id){
                // COPY /somedatabase/some_doc HTTP/1.1
                // Destination: some_other_doc?rev=rev_id
                // build normal statement then add dest+rev id to header and then exec
                return self::__cc('COPY',"/$doc",false);
        }
*/
        function __cc($method='GET',$query,$database=NULL,$no_exe=false){
               $query = "curl -X $method '" . COUCH_HOST."/".($database==NULL?COUCH_DB:$database)."$query" . ' -s  -H "HTTP/1.0" '. ($method=='PUT' || $method == 'POST'? ' -H "Content-type: application/json"':NULL) ;
                // returns the appropriate curl call, no exe is for debugging (returns the command as a string)
                $result = ($no_exe==false? exec($query,$output):$query);
                // incase we have a resultset with more than a row - otherwise result is permissible
                if(count($output > 1)) {
                        $output = implode('',$output);
                        return $output;

                }
                return ($result?$result:($no_exec==true?$query:false));
        }

        function __cc_host($call,$method='GET'){
        // provides more direct access to the couch_host for some specific api calls and returns the first element in an array return
        // found in functions like get_all_dbs , get_revs_limit
                $query = "curl -X $method '" . COUCH_HOST. $call . " -s";
                $result = exec($query,$output);
                return ($output?$output[0]:$result);
        }
}